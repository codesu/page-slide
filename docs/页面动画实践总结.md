# 页面动画实践总结

## 一、项目背景

年前需要上线一个年度账单类项目，用比较炫的动画方式，呈现用户一年内的相关数据总结。

## 二、技术栈

项目内容主体为 6 页动画，进入时鉴权和请求相关用户年终数据。

实现过程如下：

1. 每个人独立完成各自页面动画，通过 `background-image` 和  `animation` 来实现图片和动画展示。
2. 通过 `webpack` 的 `html-webpack-plugin` 插件，插入每个人写的 `html` ，生成一个完成的 `index.html`。
3. `webpack` 入口文件引入各自的 `js`，可能会操作相关页面的 `dom` 元素。
4. 自定义手势库，根据 `touchStart` 和 `touchEnd` 的差值，判断翻页动作
5. 自定义翻页管理库，通过在内存中 `new image`，并指定 `src` 来预加载后续页面图片。绑定手势切换每一个页面 `div` 的 `dispaly` 来切换页面。

## 三、遇到的坑

#### 1. 微信分享不能设置一键链接

尝试多种方法，引入 `eruda` 和 `vconsole` 进行页面调试，日志都显示分享成功，但是文案和图标并不是设置的那个。

**解决办法：**

微信 `sdk` 的分享只能分享当前域名链接，在当前页面做了一键登入方法，分享当前页面。

#### 2. 切换时闪屏

通过对 `div` 的 `display` 属性进行设置，实现在各页面之间切换。然而实践中发现，前一个页面隐藏后，立即显示下一个页面，屏幕会有闪烁。

**解决办法：**

- **尝试1，添加背景色**

  这种方法还是会有瞬间没有内容展示，但是有背景色填充，会舒服一点。虽然闪屏由白色变为当前页颜色，还是觉得很突兀。

- **尝试2，修改背景图片为<img />标签**

  在 `chrome` 调试工具中发现，尽管通过 `new image` 做了预加载，切换具体页面时，还是会进行一次图片请求。将背景图片改成 `<img />` 标签实现，就不会再去请求了。这样背景图片就不会闪烁了。

- **尝试3，先显示下一页，延时移除当前页**

  理想很好，现实打脸。反复翻页时候还是会出现闪屏，尽管不需要去网络加载图片，浏览器还是需要时间去渲染。通过修改翻页时，先显示下一页，延时 50 毫秒移除当前页。

最后，发现多次翻页后，还是会出现闪屏，初步推断为浏览器会丢弃之前渲染好但是被隐藏的元素。再次显示时需要实时渲染，电脑和性能好的手机基本感觉不出，只有部分手机有瞬间闪现的过程。

**反思：**

这样的场景下，应该通过操控 `class` 来实现动画变化，而不是 `display`。然而本项目基于 `animation` 实现动画，并没有加类名，修改时间成本很大，只能使用 `display`。

#### 3. 音乐不能循环播放

在 `<audio />` 标签上添加了 `loop` 属性，却不能实现音乐循环播放，而部分手机电脑可以。

**解决办法：**

- **尝试1， 修改loop属性**

  根据 [mdn audio](https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/audio)，修改 `loop` 为 `loop=true`，发现还是不能循环播放

- **尝试2，在 onEnd 时触发播放**

  监听事件，在结束时触发播放，还是不行

- **尝试3，换链接**

  将手机连到 `mac`，通过插线联调，发现音乐文件并没有下载完成，`http code` 为 `206`，根据 [mdn 206](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/206)，代表部分加载。

  将原来经过 `nodejs` 转发的资源文件链接换为 `fps` 中的链接，循环正常。

**反思：**

可能 `nodejs` 对于 `206` 请求，并没有将剩余片段拼接返回。此猜测需要进一步验证。

## 四、需要完善的地方

#### 1. `z-index` 规范化

各个页面之间，应该规定好页面之间和页面内部的 `z-index`，这样整合起来，不会出现元素覆盖的情况。

## 五、总结

这次的项目动画效果较多，业务部分较少，代码上只有一周时间。抛弃了 `react` 等框架，我们通过原生 `js` 实现动画功能。对于之前接触较少的动画，从代码实现到工程化编译，每个人都有收获和学习。也为以后的类似项目打下基础，不走弯路。

